---
// components/ContactSection.astro
// Componente de formulario de contacto con modal de éxito

import { contactData } from "../data/contact";

// Props interface
interface Props {
    class?: string;
}

const { class: className } = Astro.props;
---

<!-- ============================================
     CONTACT SECTION - Inquiry Form
     ============================================ -->
<section
    id="contact"
    class:list={["form-section", className]}
    aria-labelledby="contact-title"
>
    <!-- Technical Badge -->
    <div class="tech-badge" aria-hidden="true">
        {contactData.badge}
    </div>

    <div class="layout-grid">
        <!-- SIDEBAR: Vertical Text (Desktop Only) -->
        <aside class="sidebar" aria-hidden="true">
            <span class="vertical-text">{contactData.sidebarText}</span>
        </aside>

        <!-- CONTENT AREA: Form -->
        <div class="content-area">
            <!-- Form Header -->
            <header class="form-header">
                <h2 id="contact-title" class="headline">
                    {contactData.title.main}
                    <br />
                    <span class="text-outline"
                        >{contactData.title.outlined}</span
                    >
                </h2>
            </header>

            <!-- Contact Form -->
            <form
                class="form-body"
                method="POST"
                action={`https://formsubmit.co/${contactData.email}`}
                id="contact-form"
            >
                <!-- FormSubmit Configuration (hidden fields) -->
                <input
                    type="hidden"
                    name="_subject"
                    value={contactData.emailSubject}
                />
                <input type="hidden" name="_template" value="box" />
                <input type="hidden" name="_captcha" value="false" />
                <!-- Webhook que retorna JSON para interceptar con JavaScript -->
                <input type="hidden" name="_webhook" value="" />

                <!-- Row 1: Name + Email -->
                <div class="field-row border-bottom">
                    <!-- Name Field -->
                    <div class="field-group border-right">
                        <label for="name" class="field-label">
                            <span class="text-red">01.</span> Nombre
                        </label>
                        <input
                            type="text"
                            id="name"
                            name="Nombre"
                            placeholder="Tu Identidad"
                            class="input-reset"
                            required
                            aria-required="true"
                        />
                    </div>

                    <!-- Email Field -->
                    <div class="field-group">
                        <label for="email" class="field-label">
                            <span class="text-red">02.</span> Email
                        </label>
                        <input
                            type="email"
                            id="email"
                            name="Email"
                            placeholder="contacto@red.com"
                            class="input-reset"
                            required
                            aria-required="true"
                        />
                    </div>
                </div>

                <!-- Row 2: Service Selection -->
                <div class="field-row border-bottom">
                    <div class="field-group w-full">
                        <label for="service" class="field-label">
                            <span class="text-red">03.</span> Interés
                        </label>
                        <div class="select-wrapper">
                            <select
                                id="service"
                                name="Servicio"
                                class="input-reset select-reset"
                                required
                                aria-required="true"
                            >
                                <option value="" disabled selected
                                    >Selecciona un servicio</option
                                >
                                {
                                    contactData.services.map((service) => (
                                        <option value={service}>
                                            {service}
                                        </option>
                                    ))
                                }
                            </select>
                            <span class="select-icon" aria-hidden="true">▼</span
                            >
                        </div>
                    </div>
                </div>

                <!-- Row 3: Message -->
                <div class="field-row">
                    <div class="field-group w-full h-auto">
                        <label for="message" class="field-label">
                            <span class="text-red">04.</span> Brief
                        </label>
                        <textarea
                            id="message"
                            name="Mensaje"
                            rows="5"
                            placeholder="Detalles de la misión..."
                            class="input-reset textarea-reset"
                            required
                            aria-required="true"></textarea>
                    </div>
                </div>

                <!-- Submit Button -->
                <button
                    type="submit"
                    class="submit-btn"
                    aria-label="Enviar formulario"
                >
                    <span class="btn-text">{contactData.submitButton.text}</span
                    >
                    <span class="btn-icon" aria-hidden="true"
                        >{contactData.submitButton.icon}</span
                    >
                </button>
            </form>
        </div>
    </div>
</section>

<!-- SUCCESS MODAL -->
<div id="success-modal" class="modal" aria-hidden="true">
    <div class="modal-overlay"></div>
    <div class="modal-content" role="dialog" aria-labelledby="modal-title">
        <button class="modal-close" aria-label="Cerrar modal">×</button>

        <span class="status-badge">TRANSMISSION_SUCCESS</span>

        <div class="success-icon" aria-hidden="true">✓</div>

        <h2 id="modal-title" class="modal-title">
            Mensaje <span class="highlight">Recibido.</span>
        </h2>

        <p class="modal-text">
            Gracias por contactar. Tu mensaje ha sido enviado exitosamente.
            Responderé a la brevedad posible, generalmente dentro de 24-48
            horas.
        </p>

        <div class="info-box">
            <p class="info-title">/// ¿Qué sigue?</p>
            <ul class="info-list">
                <li>Revisaré tu mensaje cuidadosamente</li>
                <li>Te responderé al email proporcionado</li>
                <li>Coordinaremos una llamada si es necesario</li>
            </ul>
        </div>

        <button class="modal-btn">Entendido</button>
    </div>
</div>

<!-- Client-side Form Validation & Modal Handler -->
<script>
    const form = document.getElementById("contact-form") as HTMLFormElement;
    const modal = document.getElementById("success-modal") as HTMLDivElement;
    const modalClose = document.querySelector(
        ".modal-close",
    ) as HTMLButtonElement;
    const modalBtn = document.querySelector(".modal-btn") as HTMLButtonElement;
    const modalOverlay = document.querySelector(
        ".modal-overlay",
    ) as HTMLDivElement;

    // Función para abrir el modal
    function openModal() {
        modal.classList.add("active");
        document.body.style.overflow = "hidden";
        modal.setAttribute("aria-hidden", "false");
    }

    // Función para cerrar el modal
    function closeModal() {
        modal.classList.remove("active");
        document.body.style.overflow = "";
        modal.setAttribute("aria-hidden", "true");
        form.reset();
    }

    // Event listeners para cerrar el modal
    if (modalClose) modalClose.addEventListener("click", closeModal);
    if (modalBtn) modalBtn.addEventListener("click", closeModal);
    if (modalOverlay) modalOverlay.addEventListener("click", closeModal);

    // Cerrar con ESC
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.classList.contains("active")) {
            closeModal();
        }
    });

    if (form) {
        form.addEventListener("submit", function (e) {
            e.preventDefault(); // Prevenir envío normal

            const name = (
                document.getElementById("name") as HTMLInputElement
            ).value.trim();
            const email = (
                document.getElementById("email") as HTMLInputElement
            ).value.trim();
            const service = (
                document.getElementById("service") as HTMLSelectElement
            ).value;
            const message = (
                document.getElementById("message") as HTMLTextAreaElement
            ).value.trim();

            // Basic validation
            if (!name || !email || !service || !message) {
                alert("Por favor completa todos los campos requeridos.");
                return;
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert("Por favor ingresa un email válido.");
                return;
            }

            // Show loading state
            const submitBtn = form.querySelector(
                ".submit-btn",
            ) as HTMLButtonElement;
            const btnText = submitBtn.querySelector(
                ".btn-text",
            ) as HTMLSpanElement;
            const originalText = btnText.textContent;

            btnText.textContent = "Enviando...";
            submitBtn.disabled = true;
            submitBtn.style.opacity = "0.7";
            submitBtn.style.cursor = "not-allowed";

            // Enviar con fetch para interceptar la respuesta
            const formData = new FormData(form);

            fetch(form.action, {
                method: "POST",
                body: formData,
                headers: {
                    Accept: "application/json",
                },
            })
                .then((response) => {
                    // Abrir modal independientemente de la respuesta
                    openModal();

                    // Restaurar botón
                    btnText.textContent = originalText!;
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = "";
                    submitBtn.style.cursor = "";
                })
                .catch((error) => {
                    console.error("Error:", error);
                    // Abrir modal de todas formas (FormSubmit puede dar CORS error pero el email se envía)
                    openModal();

                    // Restaurar botón
                    btnText.textContent = originalText!;
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = "";
                    submitBtn.style.cursor = "";
                });
        });

        // Real-time validation feedback - Border rojo en field-group
        const fieldGroups = form.querySelectorAll(".field-group");

        fieldGroups.forEach((fieldGroup) => {
            const input = fieldGroup.querySelector(
                "input, select, textarea",
            ) as HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement;

            if (input) {
                // Al perder foco
                input.addEventListener("blur", function () {
                    if (!input.value.trim()) {
                        fieldGroup.classList.add("error");
                    } else {
                        fieldGroup.classList.remove("error");
                    }
                });

                // Al escribir
                input.addEventListener("input", function () {
                    if (fieldGroup.classList.contains("error")) {
                        fieldGroup.classList.remove("error");
                    }
                });
            }
        });
    }
</script>

<style>
    /* ============================================
     SECTION STRUCTURE
     ============================================ */
    .form-section {
        background-color: var(--color-white);
        border-bottom: var(--border-width) solid var(--color-ink);
        position: relative;
    }

    .tech-badge {
        position: absolute;
        inset: 0 0 auto auto;
        padding: 0.5rem;
        font-family: var(--font-mono);
        font-size: 0.65rem;
        background-color: var(--color-ink);
        color: var(--color-paper);
        z-index: 10;
        letter-spacing: 0.1em;
    }

    /* ============================================
     LAYOUT GRID
     ============================================ */
    .layout-grid {
        display: grid;
        grid-template-columns: 1fr;
    }

    @media (min-width: 1024px) {
        .layout-grid {
            grid-template-columns: 1fr 11fr;
        }
    }

    /* ============================================
     SIDEBAR
     ============================================ */
    .sidebar {
        display: none;
    }

    @media (min-width: 1024px) {
        .sidebar {
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: var(--border-width) solid var(--color-ink);
            background-color: var(--color-paper);
            padding-block: 3rem;
        }
    }

    .vertical-text {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        font-family: var(--font-mono);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: var(--color-red);
    }

    /* ============================================
     FORM HEADER
     ============================================ */
    .form-header {
        padding: 2rem;
        border-bottom: var(--border-width) solid var(--color-ink);
    }

    @media (min-width: 768px) {
        .form-header {
            padding: 3rem;
        }
    }

    .headline {
        font-family: var(--font-serif);
        font-size: clamp(2.5rem, 8vw, 4.5rem);
        line-height: 0.85;
        text-transform: uppercase;
        font-weight: normal;
        margin: 0;
    }

    .text-outline {
        -webkit-text-stroke: 1px var(--color-red);
        color: transparent;
        paint-order: stroke fill;
    }

    .text-red {
        color: var(--color-red);
    }

    /* ============================================
     FORM BODY
     ============================================ */
    .form-body {
        display: flex;
        flex-direction: column;
    }

    .field-row {
        display: flex;
        flex-direction: column;
    }

    @media (min-width: 768px) {
        .field-row {
            flex-direction: row;
        }
    }

    .border-bottom {
        border-bottom: var(--border-width) solid var(--color-ink);
    }

    /* Field Group - Border rojo al tener error */
    .field-group {
        flex: 1;
        padding: 1.5rem;
        position: relative;
        transition:
            background-color 0.3s ease,
            border-color 0.3s ease;
        border: 2px solid transparent;
    }

    .field-group:focus-within {
        background-color: var(--color-paper);
    }

    .field-group.error {
        border-color: var(--color-red);
        background-color: rgba(255, 0, 0, 0.05);
    }

    .border-right {
        border-right: none;
        border-bottom: var(--border-width) solid var(--color-ink);
    }

    @media (min-width: 768px) {
        .border-right {
            border-right: var(--border-width) solid var(--color-ink);
            border-bottom: none;
        }
    }

    .field-label {
        display: block;
        font-family: var(--font-mono);
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        margin-bottom: 1rem;
        color: var(--color-ink);
        opacity: 0.8;
    }

    /* ============================================
     INPUT ELEMENTS
     ============================================ */
    .input-reset {
        width: 100%;
        background: transparent;
        border: none;
        font-family: var(--font-serif);
        font-size: clamp(1.25rem, 2vw, 1.5rem);
        color: var(--color-ink);
        padding: 0;
        outline: none;
        border-radius: 0;
    }

    .input-reset::placeholder {
        color: var(--color-ink);
        opacity: 0.2;
        font-style: italic;
    }

    .select-wrapper {
        position: relative;
        width: 100%;
    }

    .select-reset {
        appearance: none;
        cursor: pointer;
        padding-right: 2rem;
    }

    .select-icon {
        position: absolute;
        inset: 50% 0 auto auto;
        transform: translateY(-50%);
        pointer-events: none;
        color: var(--color-red);
        font-size: 0.875rem;
    }

    /* Textarea con puntos en vez de líneas */
    .textarea-reset {
        resize: vertical;
        min-height: 150px;
        font-family: var(--font-serif);
        line-height: 1.6;
        background-image: radial-gradient(
            var(--color-red) 1px,
            transparent 1px
        );
        background-size: 20px 20px;
        background-position: 0 0;
    }

    /* ============================================
     SUBMIT BUTTON
     ============================================ */
    .submit-btn {
        width: 100%;
        background: var(--color-ink);
        color: var(--color-paper);
        padding: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        border: none;
        border-top: var(--border-width) solid var(--color-ink);
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .submit-btn:hover:not(:disabled) {
        background: var(--color-red);
        padding-inline: 3rem;
    }

    .submit-btn:disabled {
        cursor: not-allowed;
        opacity: 0.7;
    }

    .btn-text {
        font-family: var(--font-mono);
        font-size: clamp(0.875rem, 1.5vw, 1rem);
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-weight: bold;
    }

    .btn-icon {
        font-size: 2rem;
        font-family: var(--font-serif);
        transition: transform 0.3s ease;
    }

    .submit-btn:hover:not(:disabled) .btn-icon {
        transform: translateX(10px);
    }

    /* ============================================
     SUCCESS MODAL
     ============================================ */
    .modal {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .modal.active {
        opacity: 1;
        pointer-events: all;
    }

    .modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(18, 18, 18, 0.8);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        position: relative;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        background: var(--color-paper);
        border: 2px solid var(--color-ink);
        padding: 3rem 2rem;
        text-align: center;
        transform: scale(0.9);
        transition: transform 0.3s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal.active .modal-content {
        transform: scale(1);
    }

    .modal-close {
        position: absolute;
        inset: 1rem 1rem auto auto;
        width: 2.5rem;
        height: 2.5rem;
        border: 1px solid var(--color-ink);
        background: var(--color-white);
        font-size: 1.5rem;
        line-height: 1;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: var(--font-serif);
    }

    .modal-close:hover {
        background: var(--color-red);
        color: var(--color-white);
        border-color: var(--color-red);
        transform: rotate(90deg);
    }

    .modal .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        font-family: var(--font-mono);
        font-size: 0.65rem;
        background-color: var(--color-ink);
        color: var(--color-paper);
        letter-spacing: 0.1em;
        margin-bottom: 2rem;
    }

    .success-icon {
        font-size: 5rem;
        color: var(--color-red);
        margin-bottom: 2rem;
        animation: checkmark 0.5s ease-in-out;
    }

    @keyframes checkmark {
        0% {
            transform: scale(0) rotate(0deg);
            opacity: 0;
        }
        50% {
            transform: scale(1.2) rotate(180deg);
        }
        100% {
            transform: scale(1) rotate(360deg);
            opacity: 1;
        }
    }

    .modal-title {
        font-family: var(--font-serif);
        font-size: clamp(2rem, 5vw, 3rem);
        line-height: 1;
        margin-bottom: 1rem;
        color: var(--color-ink);
    }

    .highlight {
        color: var(--color-red);
        font-style: italic;
    }

    .modal-text {
        font-size: 1.125rem;
        line-height: 1.6;
        color: rgba(18, 18, 18, 0.7);
        margin-bottom: 2rem;
    }

    .info-box {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--color-white);
        border: 1px solid var(--color-ink);
        text-align: left;
    }

    .info-title {
        font-family: var(--font-mono);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--color-red);
        margin-bottom: 1rem;
    }

    .info-list {
        list-style: none;
        font-family: var(--font-mono);
        font-size: 0.875rem;
        line-height: 1.8;
        padding: 0;
        margin: 0;
    }

    .info-list li::before {
        content: "→ ";
        color: var(--color-red);
        margin-right: 0.5rem;
    }

    .modal-btn {
        padding: 1rem 2rem;
        background: var(--color-ink);
        color: var(--color-paper);
        border: 1px solid var(--color-ink);
        font-family: var(--font-mono);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .modal-btn:hover {
        background: var(--color-red);
        border-color: var(--color-red);
    }

    /* ============================================
     UTILITY CLASSES
     ============================================ */
    .w-full {
        width: 100%;
    }

    .h-auto {
        height: auto;
    }

    /* ============================================
     ACCESSIBILITY
     ============================================ */
    @media (prefers-reduced-motion: reduce) {
        .field-group,
        .submit-btn,
        .btn-icon,
        .modal,
        .modal-content,
        .success-icon {
            transition: none;
            animation: none;
        }
    }

    /* ============================================
     MOBILE ADJUSTMENTS
     ============================================ */
    @media (max-width: 767px) {
        .form-header {
            padding: 1.5rem;
        }

        .field-group {
            padding: 1rem;
        }

        .submit-btn {
            padding: 1.5rem 1rem;
        }

        .modal-content {
            padding: 2rem 1.5rem;
        }
    }
</style>
